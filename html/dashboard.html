<!DOCTYPE html>
<html lang="en">
<html>
  <head>
    <title>Simple Map</title>
    <meta name="viewport" content="initial-scale=1.0">
    <meta charset="utf-8">
    <style>
      /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */
      #map {
        height: 50%;
      }
      /* Optional: Makes the sample page fill the window. */
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
        blogPostContentInput{
            height: 200px;
            width: 400px
        }
    </style>
      <script>
          var saved = "{{ saved | safe }}";
          console.log(saved);
          var postQ = "{{ post_in | safe }}"
          console.log(postQ);
          if (postQ === "1"){
            var placePk = "{{ post.place.pk | safe }}";
            var placeName = "{{ post.place.name | safe }}";
            var placeLat = "{{ post.place.lat | safe }}";
            var placeLng= "{{ post.place.lon | safe }}";
            
            var postPk = "{{ post.pk | safe }}";
            var postTitle = "{{ post.title | safe }}";
            var postContent = "{{ post.content | safe }}";
          };
          console.log(placePk);
          console.log(placeName);
      </script>
  </head>
  <body>
    <input id="pac-input" class="controls" type="text" placeholder="Search Box">
    <div id="map"></div>
    <script>
        var myLatLng = {lat: -25.363, lng: 131.044};
        var map;
        markers =[];

        function initMap() {
            if (postQ === "1"){
                myLatLng = {lat: parseFloat(placeLat), lng: parseFloat(placeLng)};
            }
            map = new google.maps.Map(document.getElementById('map'), {
                center: myLatLng,
                zoom: 4
                });

            var input = document.getElementById('pac-input');
            var searchBox = new google.maps.places.SearchBox(input);
            map.controls[google.maps.ControlPosition.TOP_LEFT].push(input);

            var markers = [];
            
            if (postQ === "1"){
                markers.push(new google.maps.Marker({
                    map:map,
                    title: placeName,
                    position: myLatLng
                }))
            }
            
            searchBox.addListener('places_changed', function() {
                var places = searchBox.getPlaces();

                if (places.length == 0) {
                    return;
                }

                // Clear out the old markers.
                markers.forEach(function(marker) {
                marker.setMap(null);
                });
                markers = [];

                // For each place, get the icon, name and location.
                var bounds = new google.maps.LatLngBounds();
                places.forEach(function(place) {
                    if (!place.geometry) {
                        console.log("Returned place contains no geometry");
                return;
                }

                // Create a marker for each place.
                markers.push(new google.maps.Marker({
                    map: map,
                    title: place.name,
                    position: place.geometry.location
                }));
                // Auto fills the lat/lng section
                document.getElementById('lat').value = place.geometry.location.lat();
                document.getElementById('lng').value = place.geometry.location.lng();
                document.getElementById('name').value = place.formatted_address;

                if (place.geometry.viewport) {
                    // Only geocodes have viewport.
                    bounds.union(place.geometry.viewport);
                } else {
                    bounds.extend(place.geometry.location);
                }
            });
            map.fitBounds(bounds);
        });

        google.maps.event.addListener(map,'click',function(event){
            clearMap();
            markers.push(new google.maps.Marker({
                position: {lat: event.latLng.lat(), lng: event.latLng.lng()},
                map: map,
                title: "You clicked here!"
                }));
            document.getElementById('lat').value = event.latLng.lat();
            document.getElementById('lng').value = event.latLng.lng();
        });
        function setMapOnAll(map) {
        for (var i = 0; i < markers.length; i++) {
            markers[i].setMap(map);
        }};
        function clearMap(){
            setMapOnAll(null);
            };
        };

    </script>
    <script
            src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDj6i75TUGUFEf-qaexR0kfW60w-G2XmEs&libraries=places&callback=initMap"
    async defer></script>
    <script>
        document.write(saved);
    </script>
    <form action="/dashboard/" enctype="multipart/form-data" id="post_form", method="post">{% csrf_token %}
        <p class ="form_prompts" id="title">Add place:</p>
        <p class ="form_prompts">Place name:</p>
        <input type="text"
               name="placePk"
               hidden
               id = "placePk"
               value = "0"/>
        <input type="text"
               name="name"
               id="name" required
               pattern="^.{4,100}"
               title ="Place name must be a minimum of four characters." /><br>
        <p class ="form_prompts">lat:</p>
        <input type="text"
               name="lat"
               id="lat"
               required pattern="^-?([1-8]?[1-9]|[1-9]0)\.{1}\d{0,17}"
               title="Lattitude must be a number between -90 and 90." /><br>
        <p class ="form_prompts">lng:</p>
        <input type="text"
               name="lng"
               id="lng"
               required
               pattern="^-?([1][1-7][0-9]|[1-9][0-9]|[0-9])\.{1}\d{1,17}"
               title="Longitude must be a number between -180 and 180." /><br><br>
        <p class ="form_prompts" id="title">Add post:</p>
        <input type="text"
               name="postPk"
               hidden
               id="postPk"
               value = "0"/>
        <input type="file" name="pic" accept="image/*"/>
        <p class ="form_prompts" style="display: inline">Post Title: </p>
        <input type="text" 
               name="post_title"
               id="post_title"
               required pattern="^.{4,100}"
               title="Post Title must be a minimum of four characters." /><br>
    </form>
    <textarea name="post_content" id="post_content" form="post_form" class="blogPostContentInput" rows ="20" cols ="100">This is a blog post</textarea><br>
    <input type="submit" value="save_post" form="post_form"><br>
      <script>
            function autoFillForm(){
                if (postQ === "1"){
                    document.getElementById('placePk').value = placePk;
                    document.getElementById('name').value = placeName;
                    document.getElementById('lat').value = placeLat;
                    document.getElementById('lng').value = placeLng;
                    
                    document.getElementById('postPk').value = postPk;
                    document.getElementById('post_title').value = postTitle;
                    document.getElementById('post_content').value = postContent;
                }
            }
            autoFillForm();
      </script>
    <h1><a href="/edit_post">Edit existing post</a></h1>
    <h1>Hi Farha!</h1><br/>
    <h1>You travelled {{distance}}km today,</h1><br/>
    <h1>Your average speed was {{averageSpeed}}km/h,</h1><br/>
    <h1>and you were cycling for {{movingTime}} seconds.</h1>
    <h1><a href="/logout/">Logout!</a> </h1>
</body>
</html>